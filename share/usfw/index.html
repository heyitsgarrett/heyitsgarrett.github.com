<!DOCTYPE html>
<html>
<head>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.0/jquery.min.js"></script>
    <script src='http://underscorejs.org/underscore-min.js'></script>

    <script src='http://api.tiles.mapbox.com/mapbox.js/v1.0.2/mapbox.js'></script>
    <link href='http://api.tiles.mapbox.com/mapbox.js/v1.0.2/mapbox.css' rel='stylesheet' />
<!--[if lte IE 8]>
<link href='http://api.tiles.mapbox.com/mapbox.js/v1.0.2/mapbox.ie.css' rel='stylesheet' >
<![endif]-->
<style>
body { margin:0; padding:0; }
#map { position:absolute; top:0; bottom:0; width:100%; }
</style>
</head>
<body>
    <div id='map'></div>
    <script type='text/javascript'>

        function fusionTables(id, callback) {

            function isNumber(n) {
                return !isNaN(parseFloat(n)) && isFinite(n);
            }

            function response(x) {
                console.log(x);
                var features = [];
                if (!x || !x.rows) return features;
                for (var i = 0; i < x.rows.length; i++) {
                    var entry = x.rows[i];

                    var coords = entry[11].split(', ');
                    var color = entry[0].split('_');
                        color = color[1];
                    var markerColor = '333333';

                    if(color === 'green') {
                        markerColor = '66cc33'
                    } else if (color === 'red') {
                        markerColor = 'CC0000'
                    } else if (color === 'brown') {
                        markerColor = '663300'
                    } else if (color === 'purple') {
                        markerColor = '660099'
                    } else if (color === 'yellow') {
                        markerColor = 'ffff33'
                    } else if (color === 'turquoise') {
                        markerColor = '66ccff'
                    }

                    var feature = {
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: [parseFloat(coords[1]), parseFloat(coords[0])]
                        },
                        properties: {
                            "marker-color": markerColor,
                            "marker-size": "small",
                            "title": entry[1] + ' (Grant No. ' + entry[2] + ')',
                            "description": '<p>' + entry[4] + '</p>' + '<hr />' + '<p>' + entry[9] + '</p>'
                        }
                    };
                    if(isNumber(coords[0])) {
                        features.push(feature);
                    } else {
                        // Invalid coordinates, not adding marker
                    }
                }

                return callback(features);
            }

            var key = "AIzaSyBxFSOU3V-i4WePI1GKeys96Au9gJ0O-mo";
            var url = 'https://www.googleapis.com/fusiontables/v1/query?sql=SELECT%20*%20FROM%20' + id + '&key=' + key + '&typed=false&callback=jsonp';

            $.ajax({
                url: url,
                dataType: 'jsonp',
                jsonpCallback: 'jsonp',
                success: response,
                error: response
            });
        }

        // enter the id of the fusion table you want to show on the map

        fusionTables('1UWc2-AzgjBOoSvhI1st3MHuYzO4Ul9bVXGthjEY', function(features) {

            var map = L.mapbox.map('map', 'examples.map-4l7djmvo');

            var geoJson = {
                    type: 'FeatureCollection',
                    features: features
                };

            map.markerLayer.setGeoJSON(geoJson);
        });

    </script>
</body>
</html>